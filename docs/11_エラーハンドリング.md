# 11_エラーハンドリング

**Phase**: Phase 5 (Week 4)

## 概要
アプリ全体に堅牢なエラーハンドリングを実装し、ユーザーフレンドリーなエラーメッセージを表示します。

## タスク
- [×] CSVアップロード関連
  - [×] ファイル未選択時のメッセージ（Streamlit標準）
  - [×] ファイル形式エラー（CSV以外） - `validate_file_extension()`
  - [×] エンコーディングエラー（UTF-8/Shift-JIS/CP932/ISO-8859-1/Latin1自動検出）
  - [×] ファイルサイズ制限（200MB以上で警告） - `validate_file_size()`
  - [×] 空ファイルのチェック - `validate_data_completeness()`
- [×] データバリデーション
  - [×] 必須カラムチェック - `validate_required_columns()`
    - [×] `Order Date` 存在確認
    - [×] `Sales` 存在確認
    - [×] `Profit` 存在確認
    - [×] `Product Name` 存在確認
  - [×] データ型チェック - `validate_data_types()`
    - [×] 日付カラムのパース失敗時
    - [×] 数値カラムの型変換失敗時
  - [×] 欠損値チェック - `validate_missing_values()`
    - [×] 欠損率が50%超える場合は警告
    - [×] 重要カラムの欠損は詳細表示
  - [×] 異常値チェック - `validate_data_types()`
    - [×] 負の売上値
    - [×] 極端に大きい値（外れ値検出：99パーセンタイルの100倍以上）
    - [×] 未来の日付
- [×] グラフ生成エラー - `validate_dataframe_for_plot()`
  - [×] データ不足（最小行数チェック）
  - [×] 空のデータフレーム
  - [×] 必須カラムの欠損
  - [×] 全カラム値が欠損している場合
- [×] 予測モデルエラー
  - [×] 訓練データ不足（100行未満でエラー）
  - [×] 予測期間が長すぎる場合の警告（365日超）
  - [×] モデル訓練失敗（try-catchで捕捉）
  - [×] 数値計算エラー（NaN, Inf チェック）
- [×] PDFレポート生成エラー
  - [×] フォントファイル未発見（Helveticaにフォールバック）
  - [×] グラフ画像変換失敗（エラーメッセージ表示）
  - [×] ディスク容量不足（OSErrorで捕捉）
  - [×] 書き込み権限エラー（PermissionErrorで捕捉）

## 実装メモ
- エラーハンドリング例:
  ```python
  try:
      df = pd.read_csv(file)
  except UnicodeDecodeError:
      try:
          df = pd.read_csv(file, encoding='shift-jis')
      except Exception as e:
          st.error(f"ファイルの読み込みに失敗しました: {e}")
          st.stop()
  ```
- 必須カラムチェック:
  ```python
  required_columns = ['Order Date', 'Sales', 'Profit', 'Product Name']
  missing_columns = [col for col in required_columns if col not in df.columns]
  if missing_columns:
      st.error(f"必須カラムが不足しています: {', '.join(missing_columns)}")
      st.stop()
  ```
